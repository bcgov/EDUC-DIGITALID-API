def api_label = "api-image${UUID.randomUUID().toString()}"
podTemplate(
  label: api_label, 
  name: api_label, 
  serviceAccount: 'jenkins', 
  cloud: 'openshift', 
  containers: [
    containerTemplate(
      name: 'jnlp',
      image: 'openshift/jenkins-slave-maven-centos7',
      resourceRequestCpu: '500m',
      resourceLimitCpu: '1000m',
      resourceRequestMemory: '3Gi',
      resourceLimitMemory: '4Gi',
      workingDir: '',
      command: '',
      args: '${computer.jnlpmac} ${computer.name}'
    )
  ]
){
    node(api_label){
        stage('checkout') {
            echo "checking out source"
            checkout scm              
        }
        stage('build'){
            def bcApi = openshift.process('-f', 'tools/openshift/api.bc.yaml')
            openshift.apply(bcApi).narrow('bc').startBuild('-w').logs('-f')
        }
        stage('deploy'){
           openshift.tag("educ-pen-api:latest", "educ-pen-api:dev")
        }
    }
}
